{% extends "base.html" %}
{% block title %}Klines Data - {{ current_view_info.label if current_view_info else 'Select Interval' }}{% endblock %}

{% block content %}
<div class="bg-light p-4 p-md-5 rounded">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Klines Data Viewer</h1>
        {% if selected_symbol_id and kline_stats %}
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#klineStatsCollapse" aria-expanded="false" aria-controls="klineStatsCollapse">
            Show/Hide Symbol Stats
        </button>
        {% endif %}
    </div>

    {# Flash messages will be displayed by base.html #}
     {% if query_error %}
        <div class="alert alert-danger">{{ query_error }}</div>
    {% endif %}

    {% if selected_symbol_id and kline_stats %}
    <div class="collapse mb-4" id="klineStatsCollapse">
        <div class="card card-body">
            <h5>Statistics for Selected Symbol:</h5>
            <dl class="row">
                <dt class="col-sm-4">Raw 1-Minute Klines Count:</dt>
                <dd class="col-sm-8">{{ "{:,}".format(kline_stats.raw_1m_count) if kline_stats.raw_1m_count else 'N/A' }}</dd>

                <dt class="col-sm-4">Raw 1m Data From:</dt>
                <dd class="col-sm-8">{{ kline_stats.raw_1m_min_time.strftime('%Y-%m-%d %H:%M:%S UTC') if kline_stats.raw_1m_min_time else 'N/A' }}</dd>

                <dt class="col-sm-4">Raw 1m Data To:</dt>
                <dd class="col-sm-8">{{ kline_stats.raw_1m_max_time.strftime('%Y-%m-%d %H:%M:%S UTC') if kline_stats.raw_1m_max_time else 'N/A' }}</dd>
            </dl>
            <h6>Continuous Aggregates:</h6>
            <div class="table-responsive" style="max-height: 200px;">
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Interval</th>
                            <th>Count</th>
                            <th>From (UTC)</th>
                            <th>To (UTC)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, agg_stat in kline_stats.aggregates.items() %}
                        <tr>
                            <td>{{ agg_stat.label }}</td>
                            <td>{{ "{:,}".format(agg_stat.count) if agg_stat.count != 'N/A' and agg_stat.count is not none else agg_stat.count }}</td>
                            <td>{{ agg_stat.min_time.strftime('%Y-%m-%d %H:%M:%S') if agg_stat.min_time else 'N/A' }}</td>
                            <td>{{ agg_stat.max_time.strftime('%Y-%m-%d %H:%M:%S') if agg_stat.max_time else 'N/A' }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4">No aggregate stats available.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}


    <form method="GET" action="{{ url_for('view_klines') }}" class="row g-3 mb-4 align-items-end">
        <!-- ... form remains the same as previous version ... -->
        <div class="col-md-3">
            <label for="symbol_id" class="form-label">Symbol</label>
            <select name="symbol_id" id="symbol_id" class="form-select">
                {% if not symbols %}
                <option value="">No symbols in DB</option>
                {% endif %}
                {% for sym in symbols %}
                <option value="{{ sym.symbol_id }}" {% if sym.symbol_id == selected_symbol_id %}selected{% endif %}>
                    {{ sym.instrument_name }} ({{ sym.base_asset }}/{{ sym.quote_asset }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="interval" class="form-label">Interval</label>
            <select name="interval" id="interval" class="form-select">
                {% for key, info in aggregated_intervals_map.items() %}
                <option value="{{ key }}" {% if key == selected_interval_key %}selected{% endif %}>{{ info.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-auto" style="min-width: 180px;">
            <label for="start_time" class="form-label">Start (UTC)</label>
            <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ default_start_time }}">
        </div>
        <div class="col-md-auto" style="min-width: 180px;">
            <label for="end_time" class="form-label">End (UTC)</label>
            <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ default_end_time }}">
        </div>
        <div class="col-md-1">
            <label for="limit" class="form-label">Limit</label>
            <input type="number" name="limit" id="limit" class="form-control" value="{{ limit }}" min="1" max="1000">
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Fetch Klines</button>
        </div>
    </form>

    {% if klines_data %}
    <p class="mt-3">Showing {{ klines_data|length }} of max {{ limit }} klines for <strong>{{ current_view_info.label }}</strong>.</p>
    <div class="table-responsive">
        <!-- ... klines table remains the same ... -->
        <table class="table table-striped table-hover table-sm">
            <thead class="table-dark">
                <tr>
                    <th>Time (UTC)</th>
                    <th>Open</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>Close</th>
                    <th>Volume</th>
                    <th>Trades</th>
                </tr>
            </thead>
            <tbody>
                {% for kline in klines_data %}
                <tr>
                    <td>{{ kline.time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>{{ "%.8f"|format(kline.open_price|float) }}</td>
                    <td>{{ "%.8f"|format(kline.high_price|float) }}</td>
                    <td>{{ "%.8f"|format(kline.low_price|float) }}</td>
                    <td>{{ "%.8f"|format(kline.close_price|float) }}</td>
                    <td>{{ "%.2f"|format(kline.volume|float) }}</td>
                    <td>{{ kline.number_of_trades }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif request.args.get('symbol_id') and not query_error %}
        {# Flash messages already handle "no klines found" or "aggregate populating" #}
    {% elif not symbols and not selected_symbol_id %}
         {# Flash message "No symbols found..." handles this #}
    {% endif %}
</div>
{% endblock %}